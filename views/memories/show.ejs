<h2>Here is your memory!</h2>

<body>
    <div>
        <h4><strong><%= place.name %></strong></h4>
        <p id="place-id"><%= place.id %></p>
        <p><strong><%= place.city %></strong></p>
        <p><strong><%= place.state %></strong></p>
        <p><strong><%= place.country %></strong></p>
        <p><strong><%= place.description %></strong></p>
    </div>
    
    <div class="row">
        <div class="col s4">
            <img class="responsive-img" alt="memory-image" id="memory-image" src="<%= place.imgUrl %>">
            <button id="upload_widget" class="cloudinary-button">Upload A Picture</button>
        </div> 

        <div class="col s8">
            <div id="map" class="map-container"></div>
            <pre id="info"></pre>
        </div>
    </div>

    <script>
        mapboxgl.accessToken = '<%= mapkey %>';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/mapbox/streets-v11',
            center: [-74.5, 40], // starting position
            zoom: 9 // starting zoom
        });
        map.on('mousemove', function(e) {
            document.getElementById('info').innerHTML =
            // e.point is the x, y coordinates of the mousemove event relative
            // to the top-left corner of the map
            JSON.stringify(e.point) +
            '<br />' +
            // e.lngLat is the longitude, latitude geographical position of the event
            JSON.stringify(e.lngLat.wrap());
        });
    </script>

    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>

    <script type="text/javascript">
        let pId = document.getElementById('place-id').textContent;
        console.log(pId);
        let myWidget = cloudinary.createUploadWidget({
            cloudName: 'dschawel', 
            uploadPreset: 'et0rvort'}, (error, result) => { 
            if (!error && result && result.event === "success") { 
                console.log('Done! Here is the image info: ', result.info); 
                fetch(`/memory/${pId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ imgUrl: result.info.secure_url }),
                    headers: { "Content-Type": "application/json; charset=utf-8"}
                })
                .then((response) => response.json())
                .then((data) => {
                    console.log('success', data)
                    document.getElementById('memory-image').setAttribute('src', result.info.secure_url)
                })
                .catch((error) => {
                    console.log('error', error)
                })
                }
            }
        )
        
        document.getElementById("upload_widget").addEventListener("click", function(){
            myWidget.open();
        }, false);
    </script>
</body>